<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daywise Sticky Notes ‚Äî Enhanced & Bug-Free</title>
  
  <!-- Import Google Fonts for better typography -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ========================================
       CSS CUSTOM PROPERTIES (Variables)
       These allow us to reuse values throughout our CSS
       ======================================== */
    :root{
      --bg1: #f5f7ff;
      --accent-1: #8ec5ff;
      --accent-2: #e0c3fc;
      --note-width: 220px;
      --note-height: 220px;
      --gap: 18px;
      --card-radius: 14px;
      --shadow: 0 6px 20px rgba(16,24,40,0.08);
      --glass: rgba(255,255,255,0.65);
      font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    /* Reset default browser styles */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Main body styling with gradient background */
    body {
      background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 36px;
      -webkit-font-smoothing: antialiased; /* Smoother fonts on Mac */
      min-height: 100vh; /* Ensures full viewport height */
    }

    /* Main application container with glassmorphism effect */
    .app {
      width: 1100px;
      max-width: calc(100% - 48px);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px); /* Creates glass effect */
    }

    /* Header section with logo and controls */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      flex-wrap: wrap; /* Allows wrapping on small screens */
      gap: 12px;
    }

    /* Brand section (logo + title) */
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Logo styling */
    .logo {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.6) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #253858;
      font-family: 'Poppins';
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      font-size: 20px;
    }

    /* Main title */
    h1 {
      margin: 0;
      font-size: 18px;
      color: #243447;
      font-family: 'Poppins', sans-serif;
    }

    /* Subtitle text */
    p.subtitle {
      margin: 0;
      color: #667085;
      font-size: 13px;
    }

    /* Controls section in header */
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Inherit font for all form elements */
    input, select, button {
      font-family: inherit;
    }

    /* Date picker wrapper */
    .date-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Date input styling */
    .date-wrap input[type="date"] {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(16,24,40,0.06);
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-wrap input[type="date"]:hover {
      border-color: #2b6ef6;
    }

    /* Toolbar buttons container */
    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Primary button styling */
    .btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 0;
      background: #2b6ef6;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease; /* Smooth hover effect */
      white-space: nowrap; /* Prevent text wrapping */
    }

    /* Button hover effect */
    .btn:hover {
      background: #1e5dd6;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(43,110,246,0.3);
    }

    /* Button active (clicked) effect */
    .btn:active {
      transform: translateY(0);
    }

    /* Ghost button variant (outlined) */
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(16,24,40,0.1);
      color: #243447;
    }

    .btn.ghost:hover {
      background: rgba(16,24,40,0.05);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Small button variant */
    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    /* Main content area with sidebar and notes grid */
    .main {
      display: flex;
      gap: 20px;
    }

    /* Left sidebar (form and controls) */
    .left {
      width: 360px;
      flex-shrink: 0; /* Prevents shrinking */
    }

    /* Right section (notes display) */
    .right {
      flex: 1; /* Takes remaining space */
      min-width: 0; /* Allows flex item to shrink below content size */
    }

    /* New note creation form */
    .new-note {
      background: var(--glass);
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(16,24,40,0.04);
      margin-bottom: 12px;
    }

    /* Form labels */
    .new-note label {
      display: block;
      font-size: 12px;
      color: #334155;
      margin-bottom: 6px;
      font-weight: 600;
    }

    /* Text inputs and textareas */
    .new-note input[type="text"],
    .new-note textarea,
    .new-note select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(16,24,40,0.06);
      resize: none;
      font-size: 13px;
      transition: border-color 0.2s ease;
      box-sizing: border-box; /* Include padding in width calculation */
    }

    /* Input focus effect */
    .new-note input[type="text"]:focus,
    .new-note textarea:focus,
    .new-note select:focus {
      outline: none;
      border-color: #2b6ef6;
      box-shadow: 0 0 0 3px rgba(43,110,246,0.1);
    }

    /* Textarea specific height */
    .new-note textarea {
      height: 100px;
      font-family: inherit;
    }

    /* Flexible row layout for form elements */
    .row {
      display: flex;
      gap: 8px;
    }

    /* Notes grid container */
    .notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--note-width), 1fr));
      gap: var(--gap);
      padding: 10px;
    }

    /* Individual sticky note styling */
    .note {
      width: 100%;
      max-width: var(--note-width);
      height: var(--note-height);
      border-radius: 12px;
      padding: 12px;
      position: relative;
      box-shadow: 0 6px 18px rgba(2,6,23,0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: default;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* Note hover effect */
    .note:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(2,6,23,0.18);
    }

    /* Note title */
    .note .title {
      font-weight: 700;
      font-size: 13px;
      color: #1a1a1a;
      word-wrap: break-word;
    }

    /* Note content area */
    .note .content {
      flex: 1;
      font-size: 13px;
      overflow: auto;
      word-wrap: break-word;
      color: #2d2d2d;
      line-height: 1.4;
    }

    /* Note metadata footer */
    .note .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-top: auto;
    }

    /* Note action buttons container */
    .note .actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* Progress tag styling */
    .tag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.1);
      white-space: nowrap;
      font-weight: 600;
    }

    /* Note color variants */
    .note.yellow {
      background: linear-gradient(180deg, #fff7c2, #fff4a8);
      border: 1px solid rgba(251, 191, 36, 0.2);
    }

    .note.pink {
      background: linear-gradient(180deg, #ffd6e7, #ffd3df);
      border: 1px solid rgba(244, 114, 182, 0.2);
    }

    .note.green {
      background: linear-gradient(180deg, #d8ffd8, #c8f4cc);
      border: 1px solid rgba(74, 222, 128, 0.2);
    }

    .note.blue {
      background: linear-gradient(180deg, #dff2ff, #cfe9ff);
      border: 1px solid rgba(96, 165, 250, 0.2);
    }

    /* Small text utility class */
    .small {
      font-size: 12px;
      color: #334155;
    }

    /* Filters section */
    .filters {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    /* Footer styling */
    footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Muted text */
    .muted {
      color: #6b7280;
      font-size: 13px;
    }

    /* Selection card styling */
    .selection-card {
      margin-top: 12px;
      padding: 12px;
      background: var(--glass);
      border-radius: 12px;
      border: 1px solid rgba(16,24,40,0.04);
    }

    /* Checkbox styling */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #2b6ef6;
    }

    /* Empty state message */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    /* Toast notification styling */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: #111827;
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.3);
      z-index: 9999;
      animation: slideIn 0.3s ease;
      max-width: 300px;
      word-wrap: break-word;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ========================================
       RESPONSIVE DESIGN
       Makes the app work well on mobile devices
       ======================================== */
    @media (max-width: 900px) {
      body {
        padding: 16px;
      }

      .app {
        padding: 16px;
        max-width: 100%;
      }

      /* Stack sidebar and notes vertically */
      .main {
        flex-direction: column;
      }

      .left {
        width: 100%;
      }

      /* Adjust header for mobile */
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .controls {
        width: 100%;
        justify-content: flex-start;
      }

      /* Smaller notes on mobile */
      .notes-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
      }

      .note {
        max-width: 100%;
        height: 200px;
      }
    }

    /* Extra small screens */
    @media (max-width: 500px) {
      .notes-grid {
        grid-template-columns: 1fr;
      }

      .toolbar {
        width: 100%;
      }

      .btn {
        flex: 1;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- ========================================
         HEADER SECTION
         Contains branding, date picker, and main action buttons
         ======================================== -->
    <header>
      <div class="brand">
        <div class="logo">üìù</div>
        <div>
          <h1>Daywise Sticky Notes</h1>
          <p class="subtitle">Create notes tied to a date ‚Äî copy, paste, filter and download.</p>
        </div>
      </div>

      <div class="controls">
        <div class="date-wrap">
          <label class="small" for="activeDate">Active date</label>
          <input id="activeDate" type="date" />
        </div>
        <div class="toolbar">
          <button class="btn" id="addNoteBtn">+ Add Note</button>
          <button class="btn ghost" id="pasteBtn">üìã Paste</button>
        </div>
      </div>
    </header>

    <!-- ========================================
         MAIN CONTENT AREA
         Split into left sidebar (form) and right area (notes display)
         ======================================== -->
    <div class="main">
      <!-- LEFT SIDEBAR: Note creation form and controls -->
      <aside class="left">
        <!-- Note Creation Form -->
        <div class="new-note">
          <label>Title</label>
          <input id="noteTitle" type="text" placeholder="Short title" maxlength="100" />

          <label style="margin-top:10px">Content</label>
          <textarea id="noteContent" placeholder="Write your note or paste content"></textarea>

          <!-- Color and Progress Selection Row -->
          <div style="margin-top:8px" class="row">
            <select id="noteColor" style="flex:1">
              <option value="yellow">üü° Yellow</option>
              <option value="pink">üî¥ Pink</option>
              <option value="green">üü¢ Green</option>
              <option value="blue">üîµ Blue</option>
            </select>
            <select id="noteProgress" style="flex:1">
              <option value="todo">üìã To Do</option>
              <option value="inprogress">‚öôÔ∏è In Progress</option>
              <option value="done">‚úÖ Done</option>
            </select>
          </div>

          <!-- Create/Update Button -->
          <button class="btn" id="createNote" style="width:100%;margin-top:8px">Create Note</button>

          <!-- Filter by Progress -->
          <div style="margin-top:12px">
            <label>Filter by progress</label>
            <select id="filterProgress" style="width:100%;margin-top:4px">
              <option value="all">All Progress</option>
              <option value="todo">To Do</option>
              <option value="inprogress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <!-- Download Options -->
          <div style="margin-top:12px">
            <label>Download options</label>
            <div style="display:flex;gap:8px;margin-top:4px">
              <select id="downloadProgress" style="flex:1">
                <option value="all">All progress</option>
                <option value="todo">To Do</option>
                <option value="inprogress">In Progress</option>
                <option value="done">Done</option>
              </select>
              <button class="btn" id="downloadFiltered">‚¨áÔ∏è Download</button>
            </div>
          </div>

          <!-- Helpful Tip -->
          <div style="margin-top:12px" class="small muted">
            üí° <strong>Tip:</strong> Select a date at the top to switch between days. All notes are saved in your browser.
          </div>
        </div>

        <!-- Selection Management Card -->
        <div class="selection-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div class="small">Selected notes</div>
              <div id="selectedCount" style="font-weight:600;color:#243447">0 selected</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost small" id="selectAll">Select All</button>
              <button class="btn ghost small" id="clearAll">Clear</button>
            </div>
          </div>
          <button class="btn" id="downloadSelected" style="width:100%;margin-top:8px">‚¨áÔ∏è Download Selected</button>
          <div class="small" style="margin-top:8px">Use the checkbox on each note to mark for bulk actions.</div>
        </div>
      </aside>

      <!-- RIGHT SECTION: Notes Display Grid -->
      <section class="right">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <div class="small">Notes for <strong id="displayDate"></strong></div>
          <button class="btn ghost small" id="clearDay">üóëÔ∏è Clear Day</button>
        </div>

        <!-- Notes Container -->
        <div id="notesWrap">
          <div class="notes-grid" id="notesGrid"></div>
        </div>
      </section>
    </div>

    <!-- Footer with info -->
    <footer>
      <div class="muted">Built with Open Sans & Poppins ‚Äî Professional sticky notes</div>
      <div class="muted">üîí Local only ‚Äî All data saved in your browser</div>
    </footer>
  </div>

  <script>
    /* ========================================
       JAVASCRIPT APPLICATION CODE
       This section handles all the app logic
       ======================================== */

    // Wait for the entire page to load before running our code
    // This ensures all HTML elements are available
    document.addEventListener('DOMContentLoaded', () => {
      
      /* ========================================
         UTILITY FUNCTIONS & CONSTANTS
         ======================================== */
      
      // Helper function to quickly get elements by ID
      // Instead of writing document.getElementById() every time, we use $(id)
      const $ = (id) => document.getElementById(id);
      
      // Key name for storing data in localStorage
      // Using a version suffix helps us migrate data if structure changes
      const NOTES_KEY = 'daywise_notes_v1';

      /* ========================================
         DATABASE INITIALIZATION
         Load existing notes from browser storage
         ======================================== */
      
      let db = (() => {
        try {
          // Try to load existing notes from localStorage
          const stored = localStorage.getItem(NOTES_KEY);
          // If data exists, parse it from JSON string to object
          // If no data, return empty object
          return stored ? JSON.parse(stored) : {};
        } catch (e) {
          // If parsing fails (corrupted data), log error and start fresh
          console.error('Failed to load database:', e);
          return {};
        }
      })();

      /* ========================================
         SEED SAMPLE DATA
         Create sample notes for first-time users
         ======================================== */
      
      // Get today's date in YYYY-MM-DD format
      const today = new Date().toISOString().slice(0, 10);
      
      // If no notes exist for today, create sample notes
      if (!db[today] || db[today].length === 0) {
        db[today] = [
          {
            id: 'sample-1',
            title: 'Welcome! üëã',
            content: 'This is a sample note. You can:\n‚Ä¢ Create new notes\n‚Ä¢ Edit existing ones\n‚Ä¢ Copy content to clipboard\n‚Ä¢ Download notes as JSON or TXT\n‚Ä¢ Filter by progress status',
            color: 'yellow',
            progress: 'todo',
            createdAt: new Date().toISOString()
          },
          {
            id: 'sample-2',
            title: 'Features ‚ú®',
            content: 'Try these features:\n‚Ä¢ Switch dates to organize notes by day\n‚Ä¢ Use checkboxes for bulk actions\n‚Ä¢ Filter notes by To Do/In Progress/Done\n‚Ä¢ Paste from clipboard directly',
            color: 'blue',
            progress: 'inprogress',
            createdAt: new Date().toISOString()
          },
          {
            id: 'sample-3',
            title: 'Completed Example ‚úÖ',
            content: 'This note is marked as done. Change progress status using the dropdown when creating or editing notes.',
            color: 'green',
            progress: 'done',
            createdAt: new Date().toISOString()
          }
        ];
        // Save the sample data to localStorage
        saveDB();
      }

      /* ========================================
         DOM ELEMENT REFERENCES
         Get references to all elements we'll use
         ======================================== */
      
      const activeDateInput = $('activeDate');
      const displayDate = $('displayDate');
      const notesGrid = $('notesGrid');
      const filterProgress = $('filterProgress');
      const downloadProgress = $('downloadProgress');
      const selectedCountEl = $('selectedCount');
      const noteTitle = $('noteTitle');
      const noteContent = $('noteContent');
      const noteColor = $('noteColor');
      const noteProgressSelect = $('noteProgress');
      const createBtn = $('createNote');

      // Safety check: ensure critical elements exist
      if (!activeDateInput || !notesGrid || !createBtn) {
        console.error('Critical DOM elements missing. App cannot function.');
        showToast('‚ùå App initialization failed. Please refresh the page.');
        return;
      }

      /* ========================================
         INITIALIZE DATE PICKER
         Set today's date as the active date
         ======================================== */
      
      activeDateInput.value = today;
      renderDisplayDate();

      /* ========================================
         CORE HELPER FUNCTIONS
         ======================================== */

      /**
       * Save the database to localStorage
       * Called whenever notes are created, updated, or deleted
       */
      function saveDB() {
        try {
          // Convert the database object to JSON string and save
          localStorage.setItem(NOTES_KEY, JSON.stringify(db));
        } catch (e) {
          // If save fails (storage full, etc.), notify user
          console.error('Failed to save database:', e);
          showToast('‚ö†Ô∏è Failed to save. Storage might be full.');
        }
      }

      /**
       * Generate a unique ID for new notes
       * Uses random characters for simplicity
       */
      function uid() {
        return 'note-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
      }

      /**
       * Get all notes for a specific date
       * @param {string} date - Date in YYYY-MM-DD format
       * @returns {array} Array of note objects
       */
      function notesForDate(date) {
        return db[date] || [];
      }

      /**
       * Update the displayed date text
       * Shows which day's notes are currently being viewed
       */
      function renderDisplayDate() {
        if (displayDate && activeDateInput.value) {
          // Format the date nicely for display
          const dateObj = new Date(activeDateInput.value + 'T00:00:00');
          displayDate.textContent = dateObj.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        }
      }

      /**
       * Escape HTML special characters to prevent XSS attacks
       * Converts newlines to <br/> for proper display
       * @param {string} text - Raw text input
       * @returns {string} Safe HTML string
       */
      function escapeHtml(text) {
        if (!text) return '';
        return text
          .replace(/&/g, '&amp;')   // Escape ampersands first
          .replace(/</g, '&lt;')    // Escape less-than signs
          .replace(/>/g, '&gt;')    // Escape greater-than signs
          .replace(/"/g, '&quot;')  // Escape quotes
          .replace(/'/g, '&#039;')  // Escape apostrophes
          .replace(/\n/g, '<br/>'); // Convert newlines to line breaks
      }

      /**
       * Format progress status for display
       * @param {string} progress - Progress value (todo/inprogress/done)
       * @returns {string} Formatted text with emoji
       */
      function formatProgress(progress) {
        switch(progress) {
          case 'todo': return 'üìã To Do';
          case 'inprogress': return '‚öôÔ∏è In Progress';
          case 'done': return '‚úÖ Done';
          default: return progress;
        }
      }

      /**
       * Update the count of selected notes
       * Shows how many notes are currently checked
       */
      function updateSelectedCount() {
        const date = activeDateInput.value;
        const notes = notesForDate(date);
        const count = notes.filter(n => n.__selected).length;
        if (selectedCountEl) {
          selectedCountEl.textContent = `${count} selected`;
        }
      }

      /**
       * Delete a specific note
       * @param {string} date - Date key
       * @param {string} id - Note ID to delete
       */
      function deleteNote(date, id) {
        if (!db[date]) return;
        // Filter out the note with matching ID
        db[date] = db[date].filter(n => n.id !== id);
        // If no notes left for this date, remove the date key
        if (db[date].length === 0) {
          delete db[date];
        }
        saveDB();
        renderNotes();
        showToast('üóëÔ∏è Note deleted');
      }

      /* ========================================
         MAIN RENDER FUNCTION
         Displays all notes for the selected date
         ======================================== */
      
      function renderNotes() {
        try {
          const date = activeDateInput.value;
          
          // Update the display date
          renderDisplayDate();
          
          // Get notes for this date
          let notes = notesForDate(date);
          
          // Apply progress filter if selected
          const filter = filterProgress ? filterProgress.value : 'all';
          if (filter !== 'all') {
            notes = notes.filter(n => n.progress === filter);
          }
          
          // Reverse to show newest notes first
          notes = notes.slice().reverse();
          
          // Clear the grid
          notesGrid.innerHTML = '';
          
          // If no notes, show empty state
          if (notes.length === 0) {
            notesGrid.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <div style="font-size:16px;color:#243447;margin-bottom:6px">No notes yet</div>
                <div class="small muted">Create your first note using the form on the left</div>
              </div>
            `;
            updateSelectedCount();
            return;
          }
          
          // Loop through each note and create its HTML element
          for (const note of notes) {
            // Create a new article element for the note
            const noteEl = document.createElement('article');
            noteEl.className = `note ${note.color || 'yellow'}`;
            noteEl.setAttribute('data-id', note.id);
            
            // Build the note's HTML structure
            // We use escapeHtml to prevent XSS attacks
            noteEl.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:start;gap:8px">
                <div class="title">${escapeHtml(note.title || 'Untitled')}</div>
                <input type="checkbox" class="select-note" ${note.__selected ? 'checked' : ''} title="Select for bulk actions" />
              </div>
              <div class="content">${escapeHtml(note.content || '')}</div>
              <div class="meta">
                <div class="tag">${formatProgress(note.progress || 'todo')}</div>
                <div style="display:flex;gap:6px;align-items:center">
                  <button class="btn ghost small note-copy-btn" title="Copy to clipboard">üìã</button>
                  <button class="btn ghost small note-edit-btn" title="Edit note">‚úèÔ∏è</button>
                  <button class="btn ghost small note-delete-btn" title="Delete note">üóëÔ∏è</button>
                </div>
              </div>
            `;
            
            // Append the note to the grid
            notesGrid.appendChild(noteEl);
            
            // Get button references for this specific note
            const copyBtn = noteEl.querySelector('.note-copy-btn');
            const editBtn = noteEl.querySelector('.note-edit-btn');
            const deleteBtn = noteEl.querySelector('.note-delete-btn');
            const checkbox = noteEl.querySelector('.select-note');
            
            /* ========================================
               COPY BUTTON FUNCTIONALITY
               ======================================== */
            if (copyBtn) {
              copyBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // Prevent event bubbling
                
                // Prepare text to copy (title + content)
                const textToCopy = (note.title ? note.title + '\n\n' : '') + (note.content || '');
                
                if (!textToCopy.trim()) {
                  showToast('‚ö†Ô∏è Nothing to copy');
                  return;
                }
                
                try {
                  // Try modern clipboard API first
                  await navigator.clipboard.writeText(textToCopy);
                  showToast('‚úÖ Copied to clipboard!');
                } catch (err) {
                  // Fallback for browsers that don't support clipboard API
                  // or when clipboard permission is denied
                  try {
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    const success = document.execCommand('copy');
                    textarea.remove();
                    
                    if (success) {
                      showToast('‚úÖ Copied to clipboard!');
                    } else {
                      showToast('‚ö†Ô∏è Copy failed. Try manual selection.');
                    }
                  } catch (fallbackErr) {
                    console.error('Copy failed:', fallbackErr);
                    showToast('‚ùå Copy failed. Check permissions.');
                  }
                }
              });
            }
            
            /* ========================================
               EDIT BUTTON FUNCTIONALITY
               Loads note data into the form for editing
               ======================================== */
            if (editBtn) {
              editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Populate form fields with note data
                if (noteTitle) noteTitle.value = note.title || '';
                if (noteContent) {
                  // Store content as plain text (newlines intact)
                  noteContent.value = note.content || '';
                }
                if (noteColor) noteColor.value = note.color || 'yellow';
                if (noteProgressSelect) noteProgressSelect.value = note.progress || 'todo';
                
                // Store the note ID in the create button
                // This tells the create function to UPDATE instead of CREATE
                createBtn.dataset.editId = note.id;
                createBtn.textContent = 'üíæ Update Note';
                
                // Scroll to the form so user can see it
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Focus on title for immediate editing
                if (noteTitle) noteTitle.focus();
                
                showToast('üìù Editing note...');
              });
            }
            
            /* ========================================
               DELETE BUTTON FUNCTIONALITY
               ======================================== */
            if (deleteBtn) {
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Confirm before deleting
                if (confirm('Are you sure you want to delete this note?')) {
                  deleteNote(date, note.id);
                }
              });
            }
            
            /* ========================================
               CHECKBOX FUNCTIONALITY
               Tracks which notes are selected for bulk actions
               ======================================== */
            if (checkbox) {
              checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                
                // Update the note's selection state
                note.__selected = e.target.checked;
                
                // Find this note in the database and update it
                const noteIndex = db[date].findIndex(n => n.id === note.id);
                if (noteIndex !== -1) {
                  db[date][noteIndex].__selected = note.__selected;
                }
                
                // Save and update UI
                saveDB();
                updateSelectedCount();
              });
            }
          }
          
          // Update the selection counter
          updateSelectedCount();
          
        } catch (err) {
          console.error('Render failed:', err);
          showToast('‚ùå Failed to display notes');
        }
      }

      /* ========================================
         CREATE/UPDATE NOTE FUNCTIONALITY
         Handles both creating new notes and updating existing ones
         ======================================== */
      
      if (createBtn) {
        createBtn.addEventListener('click', () => {
          // Get form values
          const title = noteTitle ? noteTitle.value.trim() : '';
          const content = noteContent ? noteContent.value : '';
          
          // Validate: need at least title or content
          if (!title && !content) {
            showToast('‚ö†Ô∏è Please add a title or content');
            return;
          }
          
          // Get other form values with defaults
          const color = noteColor ? noteColor.value : 'yellow';
          const progress = noteProgressSelect ? noteProgressSelect.value : 'todo';
          const date = activeDateInput.value;
          
          // Check if we're editing an existing note
          const editId = createBtn.dataset.editId;
          
          if (editId) {
            // UPDATE MODE: Find and update the existing note
            if (!db[date]) db[date] = [];
            
            const noteIndex = db[date].findIndex(n => n.id === editId);
            if (noteIndex !== -1) {
              // Update the note while preserving other properties
              db[date][noteIndex] = {
                ...db[date][noteIndex],
                title,
                content,
                color,
                progress,
                updatedAt: new Date().toISOString()
              };
              showToast('‚úÖ Note updated!');
            }
            
            // Clear edit mode
            delete createBtn.dataset.editId;
            createBtn.textContent = 'Create Note';
            
          } else {
            // CREATE MODE: Add a new note
            const newNote = {
              id: uid(),
              title,
              content,
              color,
              progress,
              createdAt: new Date().toISOString(),
              __selected: false
            };
            
            // Initialize array if it doesn't exist
            if (!db[date]) db[date] = [];
            
            // Add note to the beginning (newest first)
            db[date].push(newNote);
            
            showToast('‚úÖ Note created!');
          }
          
          // Save to localStorage
          saveDB();
          
          // Clear the form
          if (noteTitle) noteTitle.value = '';
          if (noteContent) noteContent.value = '';
          if (noteColor) noteColor.value = 'yellow';
          if (noteProgressSelect) noteProgressSelect.value = 'todo';
          
          // Re-render the notes display
          renderNotes();
        });
      }

      /* ========================================
         EVENT LISTENERS FOR CONTROLS
         ======================================== */

      /**
       * Add Note Button
       * Scrolls to the form at the top
       */
      const addNoteBtn = $('addNoteBtn');
      if (addNoteBtn) {
        addNoteBtn.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
          if (noteTitle) noteTitle.focus();
        });
      }

      /**
       * Paste from Clipboard Button
       * Reads clipboard and adds to content textarea
       */
      const pasteBtn = $('pasteBtn');
      if (pasteBtn) {
        pasteBtn.addEventListener('click', async () => {
          try {
            // Read text from clipboard
            const text = await navigator.clipboard.readText();
            
            if (!text) {
              showToast('‚ö†Ô∏è Clipboard is empty');
              return;
            }
            
            if (noteContent) {
              // If there's existing content, add a newline before pasting
              if (noteContent.value) {
                noteContent.value += '\n\n' + text;
              } else {
                noteContent.value = text;
              }
              noteContent.focus();
              showToast('‚úÖ Pasted from clipboard!');
            }
          } catch (err) {
            console.error('Paste failed:', err);
            showToast('‚ùå Paste failed. Check clipboard permissions.');
          }
        });
      }

      /**
       * Select All Button
       * Checks all note checkboxes
       */
      const selectAllBtn = $('selectAll');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
          const date = activeDateInput.value;
          if (!db[date]) return;
          
          // Mark all notes as selected
          db[date] = db[date].map(n => ({ ...n, __selected: true }));
          saveDB();
          renderNotes();
          showToast('‚úÖ All notes selected');
        });
      }

      /**
       * Clear All Button
       * Unchecks all note checkboxes
       */
      const clearAllBtn = $('clearAll');
      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', () => {
          const date = activeDateInput.value;
          if (!db[date]) return;
          
          // Mark all notes as not selected
          db[date] = db[date].map(n => ({ ...n, __selected: false }));
          saveDB();
          renderNotes();
          showToast('‚úÖ Selection cleared');
        });
      }

      /**
       * Download Selected Button
       * Downloads only the checked notes
       */
      const downloadSelectedBtn = $('downloadSelected');
      if (downloadSelectedBtn) {
        downloadSelectedBtn.addEventListener('click', () => {
          const date = activeDateInput.value;
          const notes = (db[date] || []).filter(n => n.__selected);
          
          if (notes.length === 0) {
            showToast('‚ö†Ô∏è No notes selected');
            return;
          }
          
          // Ask user for format
          const format = prompt('Download as:\n‚Ä¢ Type "json" for JSON format\n‚Ä¢ Type "txt" for text format', 'json');
          
          if (!format) return; // User cancelled
          
          if (format.toLowerCase().startsWith('t')) {
            // TXT format
            downloadAsTxt(notes, `selected-notes-${date}.txt`);
          } else {
            // JSON format (default)
            downloadAsJson(notes, `selected-notes-${date}.json`);
          }
        });
      }

      /**
       * Download Filtered Button
       * Downloads notes based on progress filter
       */
      const downloadFilteredBtn = $('downloadFiltered');
      if (downloadFilteredBtn) {
        downloadFilteredBtn.addEventListener('click', () => {
          const date = activeDateInput.value;
          const progressFilter = downloadProgress ? downloadProgress.value : 'all';
          
          let notes = db[date] || [];
          
          // Apply progress filter
          if (progressFilter !== 'all') {
            notes = notes.filter(n => n.progress === progressFilter);
          }
          
          if (notes.length === 0) {
            showToast('‚ö†Ô∏è No notes match the filter');
            return;
          }
          
          // Ask user for format
          const format = prompt('Download as:\n‚Ä¢ Type "json" for JSON format\n‚Ä¢ Type "txt" for text format', 'json');
          
          if (!format) return;
          
          if (format.toLowerCase().startsWith('t')) {
            downloadAsTxt(notes, `notes-${date}-${progressFilter}.txt`);
          } else {
            downloadAsJson(notes, `notes-${date}-${progressFilter}.json`);
          }
        });
      }

      /**
       * Clear Day Button
       * Deletes ALL notes for the current date
       */
      const clearDayBtn = $('clearDay');
      if (clearDayBtn) {
        clearDayBtn.addEventListener('click', () => {
          const date = activeDateInput.value;
          const noteCount = (db[date] || []).length;
          
          if (noteCount === 0) {
            showToast('‚ö†Ô∏è No notes to clear');
            return;
          }
          
          // Confirm before deleting
          const confirmed = confirm(
            `Are you sure you want to delete ALL ${noteCount} note(s) for ${date}?\n\nThis action cannot be undone!`
          );
          
          if (confirmed) {
            delete db[date];
            saveDB();
            renderNotes();
            showToast('üóëÔ∏è All notes cleared for this day');
          }
        });
      }

      /**
       * Date Change Event
       * When user selects a different date, show notes for that date
       */
      if (activeDateInput) {
        activeDateInput.addEventListener('change', () => {
          // Clear edit mode when changing dates
          if (createBtn.dataset.editId) {
            delete createBtn.dataset.editId;
            createBtn.textContent = 'Create Note';
            if (noteTitle) noteTitle.value = '';
            if (noteContent) noteContent.value = '';
          }
          
          renderNotes();
        });
      }

      /**
       * Filter Change Event
       * When user changes the progress filter
       */
      if (filterProgress) {
        filterProgress.addEventListener('change', () => {
          renderNotes();
        });
      }

      /* ========================================
         DOWNLOAD HELPER FUNCTIONS
         ======================================== */

      /**
       * Download notes as JSON file
       * @param {array} notes - Array of note objects
       * @param {string} filename - Name for the downloaded file
       */
      function downloadAsJson(notes, filename) {
        try {
          // Convert notes to formatted JSON string
          const jsonString = JSON.stringify(notes, null, 2);
          
          // Create a Blob (binary data object)
          const blob = new Blob([jsonString], { type: 'application/json' });
          
          // Create a download link and trigger it
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          
          // Cleanup
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          showToast(`‚úÖ Downloaded ${notes.length} note(s) as JSON`);
        } catch (err) {
          console.error('Download failed:', err);
          showToast('‚ùå Download failed');
        }
      }

      /**
       * Download notes as plain text file
       * @param {array} notes - Array of note objects
       * @param {string} filename - Name for the downloaded file
       */
      function downloadAsTxt(notes, filename) {
        try {
          // Format each note as readable text
          const textContent = notes.map((note, index) => {
            return `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
NOTE ${index + 1}: ${note.title || 'Untitled'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Progress: ${formatProgress(note.progress || 'todo')}
Color: ${note.color || 'yellow'}
Created: ${note.createdAt ? new Date(note.createdAt).toLocaleString() : 'Unknown'}
${note.updatedAt ? 'Updated: ' + new Date(note.updatedAt).toLocaleString() : ''}

CONTENT:
${note.content || '(No content)'}

            `.trim();
          }).join('\n\n');
          
          // Add header
          const fullText = `
DAYWISE STICKY NOTES EXPORT
Generated: ${new Date().toLocaleString()}
Total Notes: ${notes.length}

${textContent}
          `.trim();
          
          // Create and download the file
          const blob = new Blob([fullText], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          showToast(`‚úÖ Downloaded ${notes.length} note(s) as TXT`);
        } catch (err) {
          console.error('Download failed:', err);
          showToast('‚ùå Download failed');
        }
      }

      /* ========================================
         TOAST NOTIFICATION FUNCTION
         Shows temporary messages to the user
         ======================================== */
      
      function showToast(message) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        
        // Add to page
        document.body.appendChild(toast);
        
        // Remove after 3 seconds with fade out animation
        setTimeout(() => {
          toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(400px)';
          
          // Remove from DOM after animation
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }

      /* ========================================
         KEYBOARD SHORTCUTS
         Add convenient keyboard shortcuts
         ======================================== */
      
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Enter: Create note
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          if (createBtn && (noteTitle === document.activeElement || noteContent === document.activeElement)) {
            e.preventDefault();
            createBtn.click();
          }
        }
        
        // Escape: Cancel edit mode
        if (e.key === 'Escape') {
          if (createBtn.dataset.editId) {
            delete createBtn.dataset.editId;
            createBtn.textContent = 'Create Note';
            if (noteTitle) noteTitle.value = '';
            if (noteContent) noteContent.value = '';
            showToast('‚úÖ Edit cancelled');
          }
        }
      });

      /* ========================================
         INITIAL RENDER
         Display notes when app first loads
         ======================================== */
      
      renderNotes();
      
      // Show welcome message
      showToast('üëã Welcome to Daywise Sticky Notes!');

    }); // End of DOMContentLoaded

    /* ========================================
       END OF APPLICATION CODE
       ======================================== */
  </script>
</body>
</html>
